---
# WebSocket upgrade handshake test

- name: Test WebSocket upgrade handshake
  delegate_to: localhost
  ansible.builtin.command:
    cmd: >
      curl -s -o /dev/null -w '%{http_code}' --max-time 5
      -H 'Connection: Upgrade'
      -H 'Upgrade: websocket'
      -H 'Sec-WebSocket-Version: 13'
      -H 'Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ=='
      http://{{ ansible_host }}:{{ api_port }}/api/v1/ws
  register: ws_result
  changed_when: false
  failed_when: false

- name: Verify WebSocket upgrade succeeded
  ansible.builtin.assert:
    that:
      - ws_result.stdout == '101'
    fail_msg: "WebSocket handshake failed (HTTP {{ ws_result.stdout }}, expected 101)"
    success_msg: "WebSocket upgrade successful (HTTP 101 Switching Protocols)"
