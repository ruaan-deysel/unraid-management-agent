---
# Unraid Management Agent — Build, Deploy, and Verify
#
# Structured as Ansible roles following 2025 best practices.
# Variables defined in group_vars/all.yml.
#
# Usage:
#   ansible-playbook -i ansible/inventory.yml ansible/deploy.yml
#
# Tags:
#   --tags build      — Build plugin package only
#   --tags deploy     — Deploy only (assumes package exists)
#   --tags verify     — Run endpoint verification only
#   --tags uninstall  — Uninstall plugin completely
#   --tags redeploy   — Full lifecycle: uninstall → build → deploy → verify
#   --skip-tags tests — Skip endpoint verification tests
#
# Extra vars:
#   -e create_backup=true — Backup existing plugin before deploy
#
# Prerequisites:
#   brew install ansible sshpass   (macOS)
#   pip install ansible            (Linux)
#   cp ansible/inventory.yml.example ansible/inventory.yml

- name: Deploy Unraid Management Agent
  hosts: unraid
  gather_facts: false

  roles:
    - role: build
      tags: [build, redeploy]

    - role: uninstall
      tags: [uninstall, redeploy]

    - role: deploy
      tags: [deploy, redeploy]

    - role: verify
      tags: [verify, tests, redeploy]

  post_tasks:
    - name: Deployment and test summary
      tags: [always]
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════
          Deployment & Test Summary
          ══════════════════════════════════════════

          Server:      {{ ansible_host }}:{{ api_port }}
          Version:     {{ version }}

          ── Endpoints ──
          API:         http://{{ ansible_host }}:{{ api_port }}/api/v1
          Swagger:     http://{{ ansible_host }}:{{ api_port }}/swagger/
          WebSocket:   ws://{{ ansible_host }}:{{ api_port }}/api/v1/ws
          MCP:         http://{{ ansible_host }}:{{ api_port }}/mcp
          Prometheus:  http://{{ ansible_host }}:{{ api_port }}/metrics

          {% if endpoint_results is defined %}
          ── Test Results ──
          Core endpoints:     {{ endpoint_results.results | selectattr('status', 'defined') | selectattr('status', 'eq', 200) | list | length }}/{{ endpoint_results.results | length }}
          Schema validations: system, array, disk, container ✓
          Parameterized:      disk, container, VM, collector, log ✓
          MCP protocol:       init, tools, resources, prompts, call, read ✓
          Prometheus:         {{ prom_result.content.split('\n') | select('match', '^# HELP unraid_') | list | length }} metric families ✓
          Swagger:            {{ swagger_doc.paths | length }} paths documented ✓
          WebSocket:          101 Switching Protocols ✓
          Error handling:     8 cases (traversal, 404, bad JSON, MCP) ✓
          Alerting CRUD:      cleanup/create/verify/delete/confirm ✓
          Health Check CRUD:  cleanup/create/run/verify/delete/confirm ✓
          Collectors:         {{ all_collectors.json | length }} registered ✓
          {% else %}
          ── Tests ──
          Use --tags verify to run endpoint tests
          {% endif %}
          ══════════════════════════════════════════
