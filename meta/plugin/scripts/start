#!/bin/bash
CONFIG_FILE="/boot/config/plugins/unraid-management-agent/config.cfg"
PROG="/usr/local/emhttp/plugins/unraid-management-agent/unraid-management-agent"
LOGS_DIR="/var/log"

# Create config directory if it doesn't exist
mkdir -p /boot/config/plugins/unraid-management-agent

# Create default config file if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]; then
    cat > "$CONFIG_FILE" << EOF
PORT=8043
EOF
fi

# Read configuration
source "$CONFIG_FILE"

# Stop if it's already running
killall unraid-management-agent >/dev/null 2>&1

# Set defaults for all values
PORT="${PORT:-8043}"
# Log level is always info by default (use --debug or --log-level CLI flag to change)
# Defaults follow industry standards (Zabbix, Prometheus, Datadog)
INTERVAL_SYSTEM="${INTERVAL_SYSTEM:-15}"
INTERVAL_ARRAY="${INTERVAL_ARRAY:-60}"
INTERVAL_DISK="${INTERVAL_DISK:-300}"
INTERVAL_DOCKER="${INTERVAL_DOCKER:-30}"
INTERVAL_VM="${INTERVAL_VM:-60}"
INTERVAL_UPS="${INTERVAL_UPS:-60}"
INTERVAL_GPU="${INTERVAL_GPU:-60}"
INTERVAL_SHARES="${INTERVAL_SHARES:-60}"
INTERVAL_NETWORK="${INTERVAL_NETWORK:-60}"
INTERVAL_HARDWARE="${INTERVAL_HARDWARE:-600}"
INTERVAL_ZFS="${INTERVAL_ZFS:-300}"
INTERVAL_NOTIFICATION="${INTERVAL_NOTIFICATION:-30}"
INTERVAL_REGISTRATION="${INTERVAL_REGISTRATION:-600}"
INTERVAL_UNASSIGNED="${INTERVAL_UNASSIGNED:-60}"

# MQTT settings (optional, disabled by default)
MQTT_ENABLED="${MQTT_ENABLED:-false}"
MQTT_BROKER="${MQTT_BROKER:-}"
MQTT_PORT="${MQTT_PORT:-1883}"
MQTT_USERNAME="${MQTT_USERNAME:-}"
MQTT_PASSWORD="${MQTT_PASSWORD:-}"
MQTT_CLIENT_ID="${MQTT_CLIENT_ID:-unraid-management-agent}"
MQTT_TOPIC_PREFIX="${MQTT_TOPIC_PREFIX:-unraid}"
MQTT_HOME_ASSISTANT="${MQTT_HOME_ASSISTANT:-false}"

# Run the application with all interval settings passed as environment variables
nohup sudo -H bash -c "
  INTERVAL_SYSTEM=$INTERVAL_SYSTEM \
  INTERVAL_ARRAY=$INTERVAL_ARRAY \
  INTERVAL_DISK=$INTERVAL_DISK \
  INTERVAL_DOCKER=$INTERVAL_DOCKER \
  INTERVAL_VM=$INTERVAL_VM \
  INTERVAL_UPS=$INTERVAL_UPS \
  INTERVAL_GPU=$INTERVAL_GPU \
  INTERVAL_SHARES=$INTERVAL_SHARES \
  INTERVAL_NETWORK=$INTERVAL_NETWORK \
  INTERVAL_HARDWARE=$INTERVAL_HARDWARE \
  INTERVAL_ZFS=$INTERVAL_ZFS \
  INTERVAL_NOTIFICATION=$INTERVAL_NOTIFICATION \
  INTERVAL_REGISTRATION=$INTERVAL_REGISTRATION \
  INTERVAL_UNASSIGNED=$INTERVAL_UNASSIGNED \
  MQTT_ENABLED=$MQTT_ENABLED \
  MQTT_BROKER=$MQTT_BROKER \
  MQTT_PORT=$MQTT_PORT \
  MQTT_USERNAME=$MQTT_USERNAME \
  MQTT_PASSWORD=$MQTT_PASSWORD \
  MQTT_CLIENT_ID=$MQTT_CLIENT_ID \
  MQTT_TOPIC_PREFIX=$MQTT_TOPIC_PREFIX \
  MQTT_HOME_ASSISTANT=$MQTT_HOME_ASSISTANT \
  $PROG --logs-dir $LOGS_DIR --port $PORT --log-level info boot
" >/dev/null 2>&1 &

echo "Unraid Management Agent started on port $PORT"
