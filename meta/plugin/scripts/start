#!/bin/bash
CONFIG_FILE="/boot/config/plugins/unraid-management-agent/config.cfg"
PROG="/usr/local/emhttp/plugins/unraid-management-agent/unraid-management-agent"
LOGS_DIR="/var/log"

# Create config directory if it doesn't exist
mkdir -p /boot/config/plugins/unraid-management-agent

# Create default config file if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]; then
    cat > "$CONFIG_FILE" << EOF
PORT=8043
LOG_LEVEL=info
EOF
fi

# Read configuration
source "$CONFIG_FILE"

# Stop if it's already running
killall unraid-management-agent >/dev/null 2>&1

# Prepare environment with defaults
export PORT="${PORT:-8043}"
export LOG_LEVEL="${LOG_LEVEL:-info}"

# Export collection intervals (new power-optimized defaults)
export INTERVAL_SYSTEM="${INTERVAL_SYSTEM:-15}"
export INTERVAL_ARRAY="${INTERVAL_ARRAY:-30}"
export INTERVAL_DISK="${INTERVAL_DISK:-30}"
export INTERVAL_DOCKER="${INTERVAL_DOCKER:-30}"
export INTERVAL_VM="${INTERVAL_VM:-30}"
export INTERVAL_UPS="${INTERVAL_UPS:-60}"
export INTERVAL_GPU="${INTERVAL_GPU:-60}"
export INTERVAL_SHARES="${INTERVAL_SHARES:-60}"
export INTERVAL_NETWORK="${INTERVAL_NETWORK:-30}"
export INTERVAL_HARDWARE="${INTERVAL_HARDWARE:-300}"
export INTERVAL_ZFS="${INTERVAL_ZFS:-30}"
export INTERVAL_NOTIFICATION="${INTERVAL_NOTIFICATION:-30}"
export INTERVAL_REGISTRATION="${INTERVAL_REGISTRATION:-300}"
export INTERVAL_UNASSIGNED="${INTERVAL_UNASSIGNED:-60}"

# Run the application with log level
nohup sudo -H bash -c "$PROG --logs-dir $LOGS_DIR --port $PORT --log-level $LOG_LEVEL boot" >/dev/null 2>&1 &

echo "Unraid Management Agent started on port $PORT with log level $LOG_LEVEL"
