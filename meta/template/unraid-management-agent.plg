<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
<!ENTITY name        "unraid-management-agent">
<!ENTITY author      "ruaan-deysel">
<!ENTITY version     "2025.11.17">
<!ENTITY launch      "Settings/&name;">
<!ENTITY gitURL      "https://github.com/ruaandeysel/&name;">
<!ENTITY pluginURL   "&gitURL;/releases/latest/download/&name;.plg">
<!ENTITY bundle      "&name;-&version;.tgz">
]>

<PLUGIN  name="&name;"
         author="&author;"
         version="&version;"
         launch="&launch;"
         pluginURL="&pluginURL;"
         support="&gitURL;/issues"
         icon="server">

<CHANGES>
###2025.11.17
- Unraid Notifications System (Issue #10)
- Complete notification management system with real-time file monitoring
- New /api/v1/notifications endpoint to list all notifications with overview counts
- New /api/v1/notifications/unread endpoint for unread notifications only
- New /api/v1/notifications/archive endpoint for archived notifications only
- New /api/v1/notifications/overview endpoint for notification counts by importance
- New /api/v1/notifications/{id} endpoint to get specific notification
- Create custom notifications via POST /api/v1/notifications
- Archive notifications via POST /api/v1/notifications/{id}/archive
- Unarchive notifications via POST /api/v1/notifications/{id}/unarchive
- Delete notifications via DELETE /api/v1/notifications/{id}
- Archive all unread notifications via POST /api/v1/notifications/archive/all
- Real-time file monitoring with fsnotify for instant notification updates
- Support for all importance levels: alert, warning, info
- Filter notifications by importance level via query parameter
- WebSocket real-time updates when notifications change

###2025.11.16
- System Log File Access API (Issue #15)
- New /api/v1/logs endpoint to list all available log files
- Log content retrieval with pagination support
- Tail behavior: ?path=/var/log/syslog&lines=100 returns last 100 lines
- Range retrieval: ?path=/var/log/syslog&start=500&lines=100 returns lines 500-600
- Automatic discovery of common Unraid logs (syslog, docker, libvirt, agent)
- Plugin log file discovery from /boot/config/plugins/*/logs/*.log
- Directory traversal protection for secure log file access

###2025.11.15
- Registration/License Information API (Issue #18)
- New /api/v1/registration endpoint for Unraid license information
- Returns license type (trial, basic, plus, pro, lifetime), state, expiration, server name, GUID
- Automatically determines license state based on expiration date and type
- Real-time updates via WebSocket when registration information changes
- Graceful handling of missing or invalid registration data

###2025.11.14
- Enhanced GPU monitoring and multi-GPU support (Issue #8 - High Priority)
- Added GPU identification fields: Index, PCIID, Vendor, UUID
- Added fan speed monitoring for NVIDIA (%) and AMD (RPM)
- Fixed AMD GPU detection: switched to radeontop for broader compatibility
- Fixed multiple Intel GPU detection (removed break statement)
- NVIDIA: Added UUID, PCI ID, fan speed monitoring
- AMD: Support for consumer Radeon GPUs (RX series), fallback to rocm-smi
- Intel: Detect all Intel GPUs (iGPU + Arc discrete)
- Backward compatible with omitempty JSON tags

###2025.11.13
- Enhanced share list API with configuration details (Issue #6)
- Eliminated N+1 query problem - single API call provides complete share info
- New share fields: comment, smb_export, nfs_export, storage, use_cache, security
- Automatic SMB/NFS export detection based on config settings
- Storage location determined from UseCache setting
- Backward compatible with omitempty tags

###2025.11.12
- Added comprehensive hardware information API (Issue #5)
- New /api/v1/hardware/* endpoints (BIOS, motherboard, CPU, cache, memory)
- Enhanced system information (HVM/IOMMU detection, OpenSSL/kernel versions)
- Enhanced network information via ethtool (link modes, duplex, auto-negotiation)
- Hardware collector runs every 5 minutes
- All hardware data cached and broadcast via WebSocket

###2025.10.03
- Initial release
- REST API with 20+ endpoints
- WebSocket support for real-time events
- Docker container control
- Virtual machine control
- System monitoring (CPU, RAM, temps, fans)
- Array status monitoring
- Disk health and SMART data
- UPS status (if available)
- GPU metrics (if available)
- Home Assistant integration ready
</CHANGES>

<!--
Unraid Management Agent - REST API and WebSocket server for Home Assistant integration.

Exposes comprehensive Unraid system monitoring and control via REST API and WebSockets.
-->

<!-- Get the plugin bundle -->
<FILE Name="/boot/config/plugins/&name;/&bundle;">
<URL>&gitURL;/releases/download/&version;/&bundle;</URL>
</FILE>

<!-- Install default configuration -->
<FILE Name="/boot/config/plugins/&name;/config.cfg">
<INLINE>
<![CDATA[
# Service configuration
SERVICE="enable"

# API configuration
PORT="8043"
ENABLE_CORS="yes"

# Feature toggles
ENABLE_UPS="yes"
ENABLE_GPU="yes"

# Collection intervals (seconds)
INTERVAL_SYSTEM="5"
INTERVAL_DISK="30"
INTERVAL_ARRAY="10"
INTERVAL_DOCKER="10"
INTERVAL_VM="10"
INTERVAL_UPS="10"
INTERVAL_SHARES="60"
]]>
</INLINE>
</FILE>

<!-- Installation script -->
<FILE Run="/bin/bash">
<INLINE>
running=$(pidof &name; | wc -w)

# Stop if running
killall &name; 2>/dev/null

# Remove old emhttp files
rm -rf /usr/local/emhttp/plugins/&name;/* 2>/dev/null

# Remove old bundle files
rm -f $(ls /boot/config/plugins/&name;/&name;*.tgz 2>/dev/null | grep -v '&version;.tgz')

# Install the bundle
tar -xf /boot/config/plugins/&name;/&bundle; -C /usr/local/emhttp/plugins

# Make scripts executable
chmod +x /usr/local/emhttp/plugins/&name;/scripts/*
chmod +x /usr/local/emhttp/plugins/&name;/event/*
chmod +x /usr/local/emhttp/plugins/&name;/&name;

# Start if it was running before
if [ $running -eq 1 ]; then
    /usr/local/emhttp/plugins/&name;/scripts/start
fi

echo ""
echo "-----------------------------------------------------------"
echo " &name; has been installed."
echo " Copyright © &author;"
echo " Version: &version;"
echo "-----------------------------------------------------------"
echo ""
</INLINE>
</FILE>

<!-- Removal script -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
# Stop the service
/usr/local/emhttp/plugins/&name;/scripts/stop

# Remove all plugin files
rm -rf /usr/local/emhttp/plugins/&name;
rm -rf /boot/config/plugins/&name;

echo ""
echo "-----------------------------------------------------------"
echo " &name; has been removed."
echo " Copyright © &author;"
echo " Version: &version;"
echo "-----------------------------------------------------------"
echo ""
</INLINE>
</FILE>

</PLUGIN>
