<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
<!ENTITY name        "unraid-management-agent">
<!ENTITY displayname "Unraid Management Agent">
<!ENTITY author      "ruaan-deysel">
<!ENTITY version     "2025.11.0">
<!ENTITY launch      "Settings/&name;">
<!ENTITY gitURL      "https://github.com/&author;/&name;">
<!ENTITY pluginURL   "&gitURL;/raw/main/&name;.plg">
<!ENTITY supportURL  "&gitURL;/issues">
<!ENTITY iconURL     "https://raw.githubusercontent.com/&author;/&name;/main/icon.png">
<!ENTITY bundle      "&name;-&version;.tgz">
<!ENTITY bundleURL   "&gitURL;/releases/download/v&version;/&bundle;">
]>

<PLUGIN  name="&displayname;"
         author="&author;"
         version="&version;"
         launch="&launch;"
         pluginURL="&pluginURL;"
         support="&supportURL;"
         icon="&iconURL;">

<CHANGES>
###2025.11.0 (2025-11-03)
- Security: Fixed path injection vulnerabilities in share config endpoints (HIGH severity)
- Added: Enhanced System Information Collector with CPU model, BIOS info, per-core CPU usage
- Added: Detailed Disk Metrics with I/O statistics and spin state detection
- Added: Input validation for share names, container IDs, VM names, and disk IDs
- Changed: Implemented automatic log rotation (5 MB max file size)
- Changed: Added configurable log levels (DEBUG, INFO, WARNING, ERROR)
- Changed: Service now auto-starts when Unraid array starts
- Fixed: Configuration synchronization issues
- Fixed: LOG_LEVEL not being read from config file
- Testing: All 66 tests passing (100% pass rate)

###2025.10.03 (Initial Release)
- Initial release with REST API and WebSocket support
- 20+ REST API endpoints for system monitoring and control
- WebSocket support for real-time events
- Docker container control (start, stop, restart, pause, unpause)
- Virtual machine control (start, stop, restart, pause, resume)
- System monitoring (CPU, RAM, temperatures, fans)
- Array status monitoring and control
- Disk health and SMART data
- UPS status monitoring (if available)
- GPU metrics (if available)
- Parity check control and history
- Configuration endpoints (read-only and write)
- Home Assistant integration ready
</CHANGES>

<!--
Unraid Management Agent - REST API and WebSocket server for comprehensive system monitoring and control.

This plugin provides a REST API and WebSocket interface for monitoring and controlling your Unraid server.
Perfect for Home Assistant integration, custom dashboards, or automation scripts.

Features:
- 20+ REST API endpoints
- Real-time WebSocket events
- Docker and VM control
- System monitoring (CPU, RAM, temps, fans, disks)
- Array management
- Parity check control
- UPS and GPU monitoring
- Secure input validation
- Automatic log rotation

Requirements:
- Unraid 6.9+ (tested on Unraid 7.x)
- Port 8043 available (configurable)

Support:
- GitHub Issues: https://github.com/ruaan-deysel/unraid-management-agent/issues
- Documentation: https://github.com/ruaan-deysel/unraid-management-agent/blob/main/README.md
-->

<!-- Download the plugin bundle -->
<FILE Name="/boot/config/plugins/&name;/&bundle;">
<URL>&bundleURL;</URL>
</FILE>

<!-- Install default configuration -->
<FILE Name="/boot/config/plugins/&name;/config.cfg">
<INLINE>
<![CDATA[
# Unraid Management Agent Configuration
# This file is automatically created if it doesn't exist

# API Server Configuration
PORT=8043
LOG_LEVEL=info

# Feature Toggles
ENABLE_UPS=yes
ENABLE_GPU=yes

# Collection Intervals (seconds)
INTERVAL_SYSTEM=5
INTERVAL_DISK=30
INTERVAL_ARRAY=10
INTERVAL_DOCKER=10
INTERVAL_VM=10
INTERVAL_UPS=10
INTERVAL_SHARES=60
]]>
</INLINE>
</FILE>

<!-- Installation script -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
#!/bin/bash

# Color codes for enhanced output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

PLUGIN_NAME="unraid-management-agent"
DISPLAY_NAME="Unraid Management Agent"
VERSION="2025.11.0"
BUNDLE="/boot/config/plugins/${PLUGIN_NAME}/unraid-management-agent-2025.11.0.tgz"
INSTALL_DIR="/usr/local/emhttp/plugins/${PLUGIN_NAME}"
CONFIG_DIR="/boot/config/plugins/${PLUGIN_NAME}"

# Print header
echo ""
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
echo -e "${CYAN}║${NC}  ${BOLD}${BLUE}${DISPLAY_NAME}${NC}                              ${CYAN}║${NC}"
echo -e "${CYAN}║${NC}  ${BOLD}Version ${VERSION}${NC}                                          ${CYAN}║${NC}"
echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Check if service is running
running=$(pidof ${PLUGIN_NAME} | wc -w)

# Stop service if running
if [ $running -ge 1 ]; then
    echo -e "${YELLOW}[1/6]${NC} Stopping existing service..."
    killall ${PLUGIN_NAME} 2>/dev/null
    sleep 2
    echo -e "      ${GREEN}✓${NC} Service stopped"
else
    echo -e "${YELLOW}[1/6]${NC} Checking for existing service..."
    echo -e "      ${BLUE}ℹ${NC} No existing service found"
fi

# Remove old plugin files
echo -e "${YELLOW}[2/6]${NC} Removing old plugin files..."
rm -rf ${INSTALL_DIR}/* 2>/dev/null
mkdir -p ${INSTALL_DIR}
echo -e "      ${GREEN}✓${NC} Old files removed"

# Remove old bundle files (keep current version)
echo -e "${YELLOW}[3/6]${NC} Cleaning up old bundles..."
rm -f $(ls ${CONFIG_DIR}/${PLUGIN_NAME}*.tgz 2>/dev/null | grep -v "${VERSION}.tgz")
echo -e "      ${GREEN}✓${NC} Cleanup complete"

# Extract the bundle
echo -e "${YELLOW}[4/6]${NC} Extracting plugin bundle..."
if [ -f "${BUNDLE}" ]; then
    tar -xzf ${BUNDLE} -C / 2>&1
    TAR_EXIT=$?
    if [ $TAR_EXIT -eq 0 ]; then
        echo -e "      ${GREEN}✓${NC} Bundle extracted successfully"
    else
        echo -e "      ${RED}✗${NC} Failed to extract bundle (exit code: $TAR_EXIT)"
        exit 1
    fi
else
    echo -e "      ${RED}✗${NC} Bundle not found: ${BUNDLE}"
    exit 1
fi

# Set executable permissions
echo -e "${YELLOW}[5/6]${NC} Setting permissions..."
chmod +x ${INSTALL_DIR}/${PLUGIN_NAME} 2>/dev/null
chmod +x ${INSTALL_DIR}/scripts/* 2>/dev/null
chmod +x ${INSTALL_DIR}/event/* 2>/dev/null

# Verify installation
if [ -f "${INSTALL_DIR}/${PLUGIN_NAME}" ]; then
    echo -e "      ${GREEN}✓${NC} Binary installed"
else
    echo -e "      ${RED}✗${NC} Binary not found after installation"
    exit 1
fi

# Start service if it was running before, or if this is a fresh install
echo -e "${YELLOW}[6/6]${NC} Starting service..."
if [ $running -ge 1 ] || [ ! -f "${CONFIG_DIR}/.installed" ]; then
    ${INSTALL_DIR}/scripts/start
    sleep 2

    # Verify service started
    if pidof ${PLUGIN_NAME} > /dev/null; then
        echo -e "      ${GREEN}✓${NC} Service started successfully"
    else
        echo -e "      ${YELLOW}⚠${NC} Service may not have started. Check logs: /var/log/${PLUGIN_NAME}.log"
    fi
else
    echo -e "      ${BLUE}ℹ${NC} Service was not running before, skipping auto-start"
fi

# Mark as installed
touch ${CONFIG_DIR}/.installed

# Print success footer
echo ""
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}  ${BOLD}${GREEN}✓ Installation Complete!${NC}                                  ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}  ${BOLD}${DISPLAY_NAME} v${VERSION}${NC}                     ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BOLD}Quick Start:${NC}"
echo -e "  ${CYAN}•${NC} API Server:     ${BLUE}http://localhost:8043${NC}"
echo -e "  ${CYAN}•${NC} Health Check:   ${BLUE}http://localhost:8043/api/v1/health${NC}"
echo -e "  ${CYAN}•${NC} Configuration:  ${BLUE}${CONFIG_DIR}/config.cfg${NC}"
echo -e "  ${CYAN}•${NC} Logs:           ${BLUE}/var/log/${PLUGIN_NAME}.log${NC}"
echo ""
echo -e "${BOLD}Documentation & Support:${NC}"
echo -e "  ${CYAN}•${NC} GitHub:  ${BLUE}https://github.com/ruaan-deysel/unraid-management-agent${NC}"
echo -e "  ${CYAN}•${NC} API Docs: See README.md for full API documentation"
echo ""
]]>
</INLINE>
</FILE>

<!-- Removal script -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
<![CDATA[
#!/bin/bash

# Color codes for enhanced output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

PLUGIN_NAME="unraid-management-agent"
DISPLAY_NAME="Unraid Management Agent"
VERSION="2025.11.0"
INSTALL_DIR="/usr/local/emhttp/plugins/${PLUGIN_NAME}"
CONFIG_DIR="/boot/config/plugins/${PLUGIN_NAME}"
LOG_FILE="/var/log/${PLUGIN_NAME}.log"

# Print header
echo ""
echo -e "${RED}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║${NC}                                                               ${RED}║${NC}"
echo -e "${RED}║${NC}  ${BOLD}${RED}Uninstalling ${DISPLAY_NAME}${NC}                    ${RED}║${NC}"
echo -e "${RED}║${NC}  ${BOLD}Version ${VERSION}${NC}                                          ${RED}║${NC}"
echo -e "${RED}║${NC}                                                               ${RED}║${NC}"
echo -e "${RED}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Stop the service
echo -e "${YELLOW}[1/3]${NC} Stopping service..."
if [ -f "${INSTALL_DIR}/scripts/stop" ]; then
    ${INSTALL_DIR}/scripts/stop
else
    killall ${PLUGIN_NAME} 2>/dev/null
fi
sleep 2

# Verify service stopped
if pidof ${PLUGIN_NAME} > /dev/null; then
    echo -e "      ${YELLOW}⚠${NC} Force stopping service..."
    killall -9 ${PLUGIN_NAME} 2>/dev/null
    sleep 1
fi

if ! pidof ${PLUGIN_NAME} > /dev/null; then
    echo -e "      ${GREEN}✓${NC} Service stopped"
else
    echo -e "      ${RED}✗${NC} Failed to stop service"
fi

# Remove plugin files
echo -e "${YELLOW}[2/3]${NC} Removing plugin files..."
rm -rf ${INSTALL_DIR}
if [ ! -d "${INSTALL_DIR}" ]; then
    echo -e "      ${GREEN}✓${NC} Plugin files removed"
else
    echo -e "      ${RED}✗${NC} Failed to remove plugin files"
fi

# Remove log file
echo -e "${YELLOW}[3/3]${NC} Removing log file..."
rm -f ${LOG_FILE}
if [ ! -f "${LOG_FILE}" ]; then
    echo -e "      ${GREEN}✓${NC} Log file removed"
else
    echo -e "      ${RED}✗${NC} Failed to remove log file"
fi

# Configuration preservation notice
echo ""
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
echo -e "${CYAN}║${NC}  ${BOLD}${BLUE}Configuration Preserved${NC}                                   ${CYAN}║${NC}"
echo -e "${CYAN}║${NC}                                                               ${CYAN}║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BOLD}Your configuration files have been preserved:${NC}"
echo -e "  ${CYAN}•${NC} Location: ${BLUE}${CONFIG_DIR}${NC}"
echo -e "  ${CYAN}•${NC} Files:    ${BLUE}config.cfg${NC}"
echo ""
echo -e "${BOLD}To completely remove all plugin data:${NC}"
echo -e "  ${YELLOW}rm -rf ${CONFIG_DIR}${NC}"
echo ""

# Print success footer
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}  ${BOLD}${GREEN}✓ Uninstallation Complete!${NC}                              ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}  ${DISPLAY_NAME} has been removed                 ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""
]]>
</INLINE>
</FILE>

</PLUGIN>

