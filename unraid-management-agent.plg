<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
    <!ENTITY name        "unraid-management-agent">
    <!ENTITY author      "ruaan-deysel">
    <!ENTITY version     "2025.11.9">
    <!ENTITY gitURL      "https://github.com/&author;/&name;">
    <!ENTITY pluginURL   "&gitURL;/raw/main/&name;.plg">
    <!ENTITY supportURL  "https://forums.unraid.net/topic/178262-home-assistant-unraid-integration">
    <!ENTITY launch      "Settings/unraid-management-agent">
    <!ENTITY bundle      "&name;-&version;.tgz">
    <!ENTITY bundleURL   "&gitURL;/releases/download/v&version;/&bundle;">
    <!ENTITY md5         "PLACEHOLDER_MD5">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" icon="server" min="6.9.0" pluginURL="&pluginURL;" support="&supportURL;">

<DESCRIPTION>
This Unraid plugin provides REST API and WebSocket interfaces for real-time system monitoring, Docker/VM control, and comprehensive hardware metrics.
</DESCRIPTION>

<CHANGES>
###2025.11.9 (2025-11-08)
- Fixed: VM collector now correctly parses VM names containing spaces
- Fixed: VM control API endpoints now work with VM names containing spaces
- Changed: VM collector uses `virsh list --all --name` for robust name parsing
- Changed: VM name validation now allows spaces in addition to alphanumeric, hyphens, underscores, and dots
- Fixed: Route parameter mismatch in VM control endpoints (changed from {id} to {name})

###2025.11.8 (2025-11-08)
- Added: User Scripts API - REST endpoints for discovering and executing Unraid User Scripts
- Added: GET /api/v1/user-scripts - List all available scripts with metadata
- Added: POST /api/v1/user-scripts/{name}/execute - Execute scripts with background/wait options
- Enables automation tools like Home Assistant to remotely execute Unraid maintenance scripts

###2025.11.7 (2025-11-08)
- Changed: Simplified README.md to essential information only (reduced file size)

###2025.11.6 (2025-11-08)
- Fixed: Plugin now displays as "Unraid Management Agent" in Plugin Manager (instead of "unraid-management-agent")
- Added: README.md file following Unraid plugin naming conventions

###2025.11.5 (2025-11-08)
- Added: USB flash drive detection - skips SMART checks on USB devices (including boot drive)
- Added: NVMe-specific SMART handling - optimized for NVMe drives (no standby check)
- Changed: Enhanced device type detection with detailed debug logging
- Aligned with ha-unraid best practices for disk spin-down compatibility

###2025.11.4 (2025-11-08)
- CRITICAL FIX: Disk spin-down compatibility - plugin now respects Unraid's disk spin-down settings
- Changed: SMART data collection now uses `smartctl -n standby` flag
- Fixed: Disks in standby mode are no longer woken up for SMART health checks

###2025.11.3 (2025-11-07)
- Fixed: Plugin icon now clickable in Unraid UI
- Fixed: Settings page URL corrected

###2025.11.2 (2025-11-06)
- Fixed: All physical disks now report correct SMART health status (was showing "UNKNOWN")
- Changed: Direct execution of smartctl command for reliable SMART data collection

###2025.11.0 (2025-11-03)
- Security: Fixed path injection vulnerabilities in share config endpoints (HIGH severity)
- Added: Enhanced System Information Collector with CPU model, BIOS info, per-core CPU usage
- Added: Detailed Disk Metrics with I/O statistics and spin state detection
- Added: Input validation for share names, container IDs, VM names, and disk IDs
- Changed: Implemented automatic log rotation (5 MB max file size)
- Changed: Added configurable log levels (DEBUG, INFO, WARNING, ERROR)
- Changed: Service now auto-starts when Unraid array starts
- Fixed: Configuration synchronization issues
- Fixed: LOG_LEVEL not being read from config file
- Testing: All 66 tests passing (100% pass rate)

###2025.10.03 (Initial Release)
- Initial release with REST API and WebSocket support
- 20+ REST API endpoints for system monitoring and control
- WebSocket support for real-time events
- Docker container control (start, stop, restart, pause, unpause)
- Virtual machine control (start, stop, restart, pause, resume)
- System monitoring (CPU, RAM, temperatures, fans)
- Array status monitoring and control
- Disk health and SMART data
- UPS status monitoring (if available)
- GPU metrics (if available)
- Parity check control and history
- Configuration endpoints (read-only and write)
- Home Assistant integration ready
</CHANGES>

<!--
Unraid Management Agent - REST API and WebSocket server for comprehensive system monitoring and control.

This plugin provides a REST API and WebSocket interface for monitoring and controlling your Unraid server.
Perfect for Home Assistant integration, custom dashboards, or automation scripts.

Features:
- 20+ REST API endpoints
- Real-time WebSocket events
- Docker and VM control
- System monitoring (CPU, RAM, temps, fans, disks)
- Array management
- Parity check control
- UPS and GPU monitoring
- Secure input validation
- Automatic log rotation

Requirements:
- Unraid 6.9+ (tested on Unraid 7.x)
- Port 8043 available (configurable)

Support:
- GitHub Issues: https://github.com/ruaan-deysel/unraid-management-agent/issues
- Documentation: https://github.com/ruaan-deysel/unraid-management-agent/blob/main/README.md
-->

<!-- Verify Unraid version compatibility -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
#!/bin/bash

# Check Unraid version compatibility
if [ -f /etc/unraid-version ]; then
    source /etc/unraid-version

    # Extract major and minor version numbers
    major_version=$(echo "$version" | cut -d'.' -f1)
    minor_version=$(echo "$version" | cut -d'.' -f2)

    # Check if version is at least 6.9.0
    if [ "$major_version" -lt 6 ] || ([ "$major_version" -eq 6 ] && [ "$minor_version" -lt 9 ]); then
        echo ""
        echo "========================================="
        echo " ERROR: Incompatible Unraid Version"
        echo "========================================="
        echo ""
        echo "This plugin requires Unraid 6.9.0 or higher."
        echo "Your current version: $version"
        echo ""
        echo "Please upgrade your Unraid system before installing this plugin."
        echo ""
        exit 1
    fi

    echo "✓ Unraid version check passed (version: $version)"
else
    echo "⚠ Warning: Could not verify Unraid version"
    echo "  Proceeding with installation..."
fi

exit 0
]]>
</INLINE>
</FILE>

<!-- Download the plugin bundle -->
<FILE Name="/boot/config/plugins/&name;/&bundle;">
<URL>&bundleURL;</URL>
<MD5>&md5;</MD5>
</FILE>

<!-- Install default configuration -->
<FILE Name="/boot/config/plugins/&name;/config.cfg">
<INLINE>
<![CDATA[
# Unraid Management Agent Configuration
# This file is automatically created if it doesn't exist

# API Server Configuration
PORT=8043
LOG_LEVEL=info

# Feature Toggles
ENABLE_UPS=yes
ENABLE_GPU=yes

# Collection Intervals (seconds)
INTERVAL_SYSTEM=5
INTERVAL_DISK=30
INTERVAL_ARRAY=10
INTERVAL_DOCKER=10
INTERVAL_VM=10
INTERVAL_UPS=10
INTERVAL_SHARES=60
]]>
</INLINE>
</FILE>

<!-- Installation script -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
#!/bin/bash

PLUGIN_NAME="unraid-management-agent"
CONFIG_DIR="/boot/config/plugins/${PLUGIN_NAME}"
INSTALL_DIR="/usr/local/emhttp/plugins/${PLUGIN_NAME}"

# Find the downloaded bundle and extract version from filename
BUNDLE=$(ls ${CONFIG_DIR}/${PLUGIN_NAME}-*.tgz 2>/dev/null | sort -V | tail -n 1)
if [ -z "$BUNDLE" ]; then
    echo "✗ Error: No plugin bundle found in ${CONFIG_DIR}"
    exit 1
fi

# Extract version from bundle filename (e.g., unraid-management-agent-2025.11.2.tgz -> 2025.11.2)
VERSION=$(basename "$BUNDLE" .tgz | sed "s/${PLUGIN_NAME}-//")

echo ""
echo "========================================="
echo " Installing ${PLUGIN_NAME}"
echo " Version: ${VERSION}"
echo "========================================="
echo ""

# Check if service is running
running=$(pidof ${PLUGIN_NAME} | wc -w)

# Stop service if running
if [ $running -ge 1 ]; then
    echo "Stopping existing service..."
    killall ${PLUGIN_NAME} 2>/dev/null
    sleep 2
fi

# Remove old plugin files
echo "Removing old plugin files..."
rm -rf ${INSTALL_DIR}/* 2>/dev/null
mkdir -p ${INSTALL_DIR}

# Remove old bundle files (keep current version)
echo "Cleaning up old bundles..."
rm -f $(ls ${CONFIG_DIR}/${PLUGIN_NAME}*.tgz 2>/dev/null | grep -v "${VERSION}.tgz")

# Extract the bundle
echo "Extracting plugin bundle..."
if [ -f "${BUNDLE}" ]; then
    tar -xzf ${BUNDLE} -C / 2>&1
    TAR_EXIT=$?
    if [ $TAR_EXIT -eq 0 ]; then
        echo "✓ Bundle extracted successfully"
    else
        echo "✗ Failed to extract bundle (exit code: $TAR_EXIT)"
        exit 1
    fi
else
    echo "✗ Bundle not found: ${BUNDLE}"
    exit 1
fi

# Set executable permissions
echo "Setting permissions..."
chmod +x ${INSTALL_DIR}/${PLUGIN_NAME} 2>/dev/null
chmod +x ${INSTALL_DIR}/scripts/* 2>/dev/null
chmod +x ${INSTALL_DIR}/event/* 2>/dev/null

# Verify installation
if [ -f "${INSTALL_DIR}/${PLUGIN_NAME}" ]; then
    echo "✓ Binary installed"
else
    echo "✗ Binary not found after installation"
    exit 1
fi

# Start service if it was running before, or if this is a fresh install
if [ $running -ge 1 ] || [ ! -f "${CONFIG_DIR}/.installed" ]; then
    echo "Starting service..."
    ${INSTALL_DIR}/scripts/start
    sleep 2
    
    # Verify service started
    if pidof ${PLUGIN_NAME} > /dev/null; then
        echo "✓ Service started successfully"
    else
        echo "⚠ Service may not have started. Check logs: /var/log/${PLUGIN_NAME}.log"
    fi
fi

# Mark as installed
touch ${CONFIG_DIR}/.installed

echo ""
echo "========================================="
echo " ${PLUGIN_NAME} v${VERSION}"
echo " Installation Complete!"
echo "========================================="
echo ""
echo "API Server: http://localhost:8043"
echo "Configuration: ${CONFIG_DIR}/config.cfg"
echo "Logs: /var/log/${PLUGIN_NAME}.log"
echo ""
echo "For documentation and support:"
echo "  https://github.com/ruaan-deysel/unraid-management-agent"
echo ""
]]>
</INLINE>
</FILE>

<!-- Removal script -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
<![CDATA[
#!/bin/bash

PLUGIN_NAME="unraid-management-agent"
INSTALL_DIR="/usr/local/emhttp/plugins/${PLUGIN_NAME}"
CONFIG_DIR="/boot/config/plugins/${PLUGIN_NAME}"
LOG_FILE="/var/log/${PLUGIN_NAME}.log"

# Try to extract version from bundle filename, fallback to "unknown" if not found
BUNDLE=$(ls ${CONFIG_DIR}/${PLUGIN_NAME}-*.tgz 2>/dev/null | sort -V | tail -n 1)
if [ -n "$BUNDLE" ]; then
    VERSION=$(basename "$BUNDLE" .tgz | sed "s/${PLUGIN_NAME}-//")
else
    VERSION="unknown"
fi

echo ""
echo "========================================="
echo " Removing ${PLUGIN_NAME}"
echo " Version: ${VERSION}"
echo "========================================="
echo ""

# Stop the service
echo "Stopping service..."
if [ -f "${INSTALL_DIR}/scripts/stop" ]; then
    ${INSTALL_DIR}/scripts/stop
else
    killall ${PLUGIN_NAME} 2>/dev/null
fi
sleep 2

# Verify service stopped
if pidof ${PLUGIN_NAME} > /dev/null; then
    echo "Force stopping service..."
    killall -9 ${PLUGIN_NAME} 2>/dev/null
    sleep 1
fi

# Final verification
if pidof ${PLUGIN_NAME} > /dev/null; then
    echo "✗ Warning: Service may still be running"
else
    echo "✓ Service stopped"
fi

echo ""
echo "Removing all plugin files and data..."
echo ""

# Remove plugin installation directory
if [ -d "${INSTALL_DIR}" ]; then
    rm -rf ${INSTALL_DIR}
    if [ $? -eq 0 ]; then
        echo "✓ Removed plugin directory: ${INSTALL_DIR}"
    else
        echo "✗ Failed to remove: ${INSTALL_DIR}"
    fi
else
    echo "  Plugin directory not found (already removed)"
fi

# Remove configuration directory
if [ -d "${CONFIG_DIR}" ]; then
    rm -rf ${CONFIG_DIR}
    if [ $? -eq 0 ]; then
        echo "✓ Removed configuration directory: ${CONFIG_DIR}"
    else
        echo "✗ Failed to remove: ${CONFIG_DIR}"
    fi
else
    echo "  Configuration directory not found (already removed)"
fi

# Remove log file
if [ -f "${LOG_FILE}" ]; then
    rm -f ${LOG_FILE}
    if [ $? -eq 0 ]; then
        echo "✓ Removed log file: ${LOG_FILE}"
    else
        echo "✗ Failed to remove: ${LOG_FILE}"
    fi
else
    echo "  Log file not found (already removed)"
fi

echo ""
echo "========================================="
echo " Complete Removal Successful"
echo "========================================="
echo ""
echo "All plugin files and data have been removed from the system."
echo ""
]]>
</INLINE>
</FILE>

</PLUGIN>

