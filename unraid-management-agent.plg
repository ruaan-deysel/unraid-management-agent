<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
    <!ENTITY name        "unraid-management-agent">
    <!ENTITY author      "ruaan-deysel">
    <!ENTITY version     "2026.03.00">
    <!ENTITY gitURL      "https://github.com/&author;/&name;">
    <!ENTITY pluginURL   "&gitURL;/raw/main/&name;.plg">
    <!ENTITY supportURL  "https://forums.unraid.net/topic/178262-home-assistant-unraid-integration">
    <!ENTITY launch      "Settings/unraid-management-agent">
    <!ENTITY bundle      "&name;-&version;.tgz">
    <!ENTITY bundleURL   "&gitURL;/releases/download/v&version;/&bundle;">
    <!ENTITY md5         "321eab32f15198ff4ae3f1bc450e2cd3">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" icon="server" min="7.2.0" pluginURL="&pluginURL;" support="&supportURL;">

<DESCRIPTION>
Monitor and control your Unraid system via REST API, WebSocket, MCP, Prometheus, and MQTT. Supports Docker/VM control, real-time metrics, Home Assistant integration, and AI agent tooling.
</DESCRIPTION>

<CHANGES>
###2026.03.00 (2026-03-01)
- 16 New MCP Tools (9 monitoring, 9 control)
- Bug fixes and performance optimizations.

###2026.02.01 (2026-02-14)
- CPU Power Consumption Monitoring
- MCP Streamable HTTP Transport
- MCP STDIO Transport

###2026.02.00 (2026-01-30)
- **Disk Model and Serial Number Population**

###2026.01.02 (2026-01-27)
- **Go 1.25.0 Upgrade**: Upgraded from Go 1.24.0 to 1.25.0 for improved performance and latest language features
- **golangci-lint v2 Migration**: Migrated to golangci-lint v2.8.0 with updated configuration format
- All code quality checks passing with zero tolerance policy
- Added: Prometheus metrics endpoint at /metrics for native Grafana integration (31 metrics covering system, array, disks, Docker, VMs, UPS, shares, network services, GPU)
- Added: Network services status API - monitors 13 services (SMB, NFS, AFP, FTP, SSH, Telnet, Avahi, NetBIOS, WSD, WireGuard, UPnP, NTP, Syslog)
- Added: Global disk temperature thresholds API (HDD and SSD thresholds from dynamix.cfg)
- Added: Per-disk temperature threshold overrides (from individual disk .cfg files)
- Added: Parity check schedule API (frequency, day, time from parity-checks.cron)
- Added: Mover schedule and status API (cron schedule, running status, thresholds)
- Added: Docker and VM service status API (enabled/disabled state)
- Added: OS and plugin update availability API (update status, versions, counts)
- Added: USB flash drive health API (capacity, usage, filesystem info)
- Added: Installed plugins list API (metadata, versions, update availability)
- Added: Share cache pool settings (primary and secondary cache pools)

###2026.01.01 (2026-01-12)
- Fixed: Log file accumulation (MaxBackups=1, MaxAge=1 day, cleanupOldLogs to remove old .gz files)
- Fixed: Dark theme support (UI now uses Unraid CSS variables and inherits colors)
- Changed: Default log level set to "info"; log level now CLI-only (UI option removed)
- Added: Model Context Protocol (MCP) support with 18 monitoring tools, 7 control tools, 5 resources, 3 prompts, new /mcp endpoint
- Added: OpenAPI/Swagger docs with 76 endpoints and "Try it out" at /swagger
- Added: Runtime collector management API (enable/disable/update interval, per-collector status, events)
- Added: Network access URLs endpoint (LAN, mDNS, WireGuard, WAN, IPv6)
- Performance: Docker SDK collector (~530x faster), VM libvirt collector (~100-200x faster), docker batching and skip stopped, UPS/NUT improvements, collectors status API, disable collectors feature, env/CLI flags to disable collectors, extended intervals up to 24h, web UI for intervals, configurable intervals persisted
- Changed: Industry-standard default intervals; start script env passthrough fix
- Fixed: Parity check status detection; disk temperature reporting; power consumption optimization (interval increases, docker batching, intel_gpu_top tuning)
</CHANGES>

<!--
Unraid Management Agent - REST API and WebSocket server for comprehensive system monitoring and control.

This plugin provides a REST API and WebSocket interface for monitoring and controlling your Unraid server.
Perfect for Home Assistant integration, custom dashboards, or automation scripts.

Features:
- 20+ REST API endpoints
- Real-time WebSocket events
- Docker and VM control
- System monitoring (CPU, RAM, temps, fans, disks)
- Array management
- Parity check control
- UPS and GPU monitoring
- Secure input validation
- Automatic log rotation

Requirements:
- Unraid 6.9+ (tested on Unraid 7.x)
- Port 8043 available (configurable)

Support:
- GitHub Issues: https://github.com/ruaan-deysel/unraid-management-agent/issues
- Documentation: https://github.com/ruaan-deysel/unraid-management-agent/blob/main/README.md
-->

<!-- Verify Unraid version compatibility -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
#!/bin/bash

# Check Unraid version compatibility
if [ -f /etc/unraid-version ]; then
    source /etc/unraid-version

    # Extract major and minor version numbers
    major_version=$(echo "$version" | cut -d'.' -f1)
    minor_version=$(echo "$version" | cut -d'.' -f2)

    # Check if version is at least 6.9.0
    if [ "$major_version" -lt 6 ] || ([ "$major_version" -eq 6 ] && [ "$minor_version" -lt 9 ]); then
        echo ""
        echo "========================================="
        echo " ERROR: Incompatible Unraid Version"
        echo "========================================="
        echo ""
        echo "This plugin requires Unraid 6.9.0 or higher."
        echo "Your current version: $version"
        echo ""
        echo "Please upgrade your Unraid system before installing this plugin."
        echo ""
        exit 1
    fi

    echo "✓ Unraid version check passed (version: $version)"
else
    echo "⚠ Warning: Could not verify Unraid version"
    echo "  Proceeding with installation..."
fi

exit 0
]]>
</INLINE>
</FILE>

<!-- Download the plugin bundle -->
<FILE Name="/boot/config/plugins/&name;/&bundle;">
<URL>&bundleURL;</URL>
<MD5>&md5;</MD5>
</FILE>

<!-- Install default configuration -->
<FILE Name="/boot/config/plugins/&name;/config.cfg">
<INLINE>
<![CDATA[
# Unraid Management Agent Configuration
# This file is automatically created if it doesn't exist

# Service configuration
SERVICE="enable"

# API Server Configuration
PORT="8043"
ENABLE_CORS="yes"

# Feature Toggles
ENABLE_UPS="yes"
ENABLE_GPU="yes"

# Collection intervals (seconds) - Power-optimized defaults
# Higher intervals reduce CPU wakeups and power consumption
INTERVAL_SYSTEM="15"
INTERVAL_ARRAY="30"
INTERVAL_DISK="30"
INTERVAL_DOCKER="30"
INTERVAL_VM="30"
INTERVAL_UPS="60"
INTERVAL_GPU="60"
INTERVAL_SHARES="60"
INTERVAL_NETWORK="30"
INTERVAL_ZFS="30"
INTERVAL_NOTIFICATION="30"
INTERVAL_HARDWARE="300"
INTERVAL_REGISTRATION="300"
INTERVAL_UNASSIGNED="60"
]]>
</INLINE>
</FILE>

<!-- Installation script -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
#!/bin/bash

PLUGIN_NAME="unraid-management-agent"
CONFIG_DIR="/boot/config/plugins/${PLUGIN_NAME}"
INSTALL_DIR="/usr/local/emhttp/plugins/${PLUGIN_NAME}"

# Find the downloaded bundle and extract version from filename
BUNDLE=$(ls ${CONFIG_DIR}/${PLUGIN_NAME}-*.tgz 2>/dev/null | sort -V | tail -n 1)
if [ -z "$BUNDLE" ]; then
    echo "✗ Error: No plugin bundle found in ${CONFIG_DIR}"
    exit 1
fi

# Extract version from bundle filename (e.g., unraid-management-agent-2025.11.2.tgz -> 2025.11.2)
VERSION=$(basename "$BUNDLE" .tgz | sed "s/${PLUGIN_NAME}-//")

echo ""
echo "========================================="
echo " Installing ${PLUGIN_NAME}"
echo " Version: ${VERSION}"
echo "========================================="
echo ""

# Check if service is running
running=$(pidof ${PLUGIN_NAME} | wc -w)

# Stop service if running
if [ $running -ge 1 ]; then
    echo "Stopping existing service..."
    killall ${PLUGIN_NAME} 2>/dev/null
    sleep 2
fi

# Remove old plugin files
echo "Removing old plugin files..."
rm -rf ${INSTALL_DIR}/* 2>/dev/null
mkdir -p ${INSTALL_DIR}

# Remove old bundle files (keep current version)
echo "Cleaning up old bundles..."
rm -f $(ls ${CONFIG_DIR}/${PLUGIN_NAME}*.tgz 2>/dev/null | grep -v "${VERSION}.tgz")

# Extract the bundle
echo "Extracting plugin bundle..."
if [ -f "${BUNDLE}" ]; then
    tar -xzf ${BUNDLE} -C / 2>&1
    TAR_EXIT=$?
    if [ $TAR_EXIT -eq 0 ]; then
        echo "✓ Bundle extracted successfully"
    else
        echo "✗ Failed to extract bundle (exit code: $TAR_EXIT)"
        exit 1
    fi
else
    echo "✗ Bundle not found: ${BUNDLE}"
    exit 1
fi

# Set executable permissions
echo "Setting permissions..."
chmod +x ${INSTALL_DIR}/${PLUGIN_NAME} 2>/dev/null
chmod +x ${INSTALL_DIR}/scripts/* 2>/dev/null
chmod +x ${INSTALL_DIR}/event/* 2>/dev/null

# Verify installation
if [ -f "${INSTALL_DIR}/${PLUGIN_NAME}" ]; then
    echo "✓ Binary installed"
else
    echo "✗ Binary not found after installation"
    exit 1
fi

# Start service if it was running before, or if this is a fresh install
if [ $running -ge 1 ] || [ ! -f "${CONFIG_DIR}/.installed" ]; then
    echo "Starting service..."
    ${INSTALL_DIR}/scripts/start
    sleep 2

    # Verify service started
    if pidof ${PLUGIN_NAME} > /dev/null; then
        echo "✓ Service started successfully"
    else
        echo "⚠ Service may not have started. Check logs: /var/log/${PLUGIN_NAME}.log"
    fi
fi

# Mark as installed
touch ${CONFIG_DIR}/.installed

echo ""
echo "========================================="
echo " ${PLUGIN_NAME} v${VERSION}"
echo " Installation Complete!"
echo "========================================="
echo ""
echo "API Server: http://localhost:8043"
echo "Configuration: ${CONFIG_DIR}/config.cfg"
echo "Logs: /var/log/${PLUGIN_NAME}.log"
echo ""
echo "For documentation and support:"
echo "  https://github.com/ruaan-deysel/unraid-management-agent"
echo ""
]]>
</INLINE>
</FILE>

<!-- Removal script -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
<![CDATA[
#!/bin/bash

PLUGIN_NAME="unraid-management-agent"
INSTALL_DIR="/usr/local/emhttp/plugins/${PLUGIN_NAME}"
CONFIG_DIR="/boot/config/plugins/${PLUGIN_NAME}"
LOG_FILE="/var/log/${PLUGIN_NAME}.log"

# Try to extract version from bundle filename, fallback to "unknown" if not found
BUNDLE=$(ls ${CONFIG_DIR}/${PLUGIN_NAME}-*.tgz 2>/dev/null | sort -V | tail -n 1)
if [ -n "$BUNDLE" ]; then
    VERSION=$(basename "$BUNDLE" .tgz | sed "s/${PLUGIN_NAME}-//")
else
    VERSION="unknown"
fi

echo ""
echo "========================================="
echo " Removing ${PLUGIN_NAME}"
echo " Version: ${VERSION}"
echo "========================================="
echo ""

# Stop the service
echo "Stopping service..."
if [ -f "${INSTALL_DIR}/scripts/stop" ]; then
    ${INSTALL_DIR}/scripts/stop
else
    killall ${PLUGIN_NAME} 2>/dev/null
fi
sleep 2

# Verify service stopped
if pidof ${PLUGIN_NAME} > /dev/null; then
    echo "Force stopping service..."
    killall -9 ${PLUGIN_NAME} 2>/dev/null
    sleep 1
fi

# Final verification
if pidof ${PLUGIN_NAME} > /dev/null; then
    echo "✗ Warning: Service may still be running"
else
    echo "✓ Service stopped"
fi

echo ""
echo "Removing all plugin files and data..."
echo ""

# Remove plugin installation directory
if [ -d "${INSTALL_DIR}" ]; then
    rm -rf ${INSTALL_DIR}
    if [ $? -eq 0 ]; then
        echo "✓ Removed plugin directory: ${INSTALL_DIR}"
    else
        echo "✗ Failed to remove: ${INSTALL_DIR}"
    fi
else
    echo "  Plugin directory not found (already removed)"
fi

# Remove configuration directory
if [ -d "${CONFIG_DIR}" ]; then
    rm -rf ${CONFIG_DIR}
    if [ $? -eq 0 ]; then
        echo "✓ Removed configuration directory: ${CONFIG_DIR}"
    else
        echo "✗ Failed to remove: ${CONFIG_DIR}"
    fi
else
    echo "  Configuration directory not found (already removed)"
fi

# Remove log file
if [ -f "${LOG_FILE}" ]; then
    rm -f ${LOG_FILE}
    if [ $? -eq 0 ]; then
        echo "✓ Removed log file: ${LOG_FILE}"
    else
        echo "✗ Failed to remove: ${LOG_FILE}"
    fi
else
    echo "  Log file not found (already removed)"
fi

echo ""
echo "========================================="
echo " Complete Removal Successful"
echo "========================================="
echo ""
echo "All plugin files and data have been removed from the system."
echo ""
]]>
</INLINE>
</FILE>

</PLUGIN>
